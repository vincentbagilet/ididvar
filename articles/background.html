<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Background on the weights ‚Ä¢ ididvar</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Lato-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Background on the weights">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ididvar</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/ididvar.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/background.html">Background on the weights</a></li>
    <li><a class="dropdown-item" href="../articles/own-viz.html">Own visualizations</a></li>
    <li><a class="dropdown-item" href="../articles/specification.html">Specification and variation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Background on the weights</h1>
            
      

      <div class="d-none name"><code>background.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentbagilet.github.io/ididvar/">ididvar</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder" class="external-link">gapminder</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/" class="external-link">fixest</a></span><span class="op">)</span></span></code></pre></div>
<p>This document very quickly introduces the maths and theory behind the
weights. More detail is available in the <a href="https://vincentbagilet.github.io/causal_exaggeration/causal_exaggeration_paper.pdf" class="external-link">associated
research paper</a>.</p>
<!-- The main objective of the `ididvar` package is to facilitate the computation and analysis of identifying variation weights.  -->
<div class="section level2">
<h2 id="intuition">Intuition<a class="anchor" aria-label="anchor" href="#intuition"></a>
</h2>
<p>These weights correspond to the leverage of each observation
<strong>after partialling out all the controls</strong>. They are
equvalent‚Äìup to a normalization to one‚Äìto the multiple regression
weights defined by <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/ajps.12185" class="external-link">Aronow
and Samii (2016)</a> and previously discussed in <a href="https://www.jstor.org/stable/j.ctvcm4j72" class="external-link">Angrist and Pischke
(2009)</a>. They represent how much each observation contributes to the
identification of a treatment variable of interest. They roughly
correspond to the leverage of the bivariate regression of the
independent variable on the treatment or main variable of interest,
after partialling out the controls, including fixed effects.
Observations for which the main variable of interest is well explained
by controls only contribute little to identification; the controls or
fixed effects absorb most of the variation.</p>
</div>
<div class="section level2">
<h2 id="theoretical-formula">Theoretical formula<a class="anchor" aria-label="anchor" href="#theoretical-formula"></a>
</h2>
<p>The weight of each observation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>‚àà</mo><mo stretchy="false" form="prefix">{</mo><mn>1</mn><mo>,</mo><mi>.</mi><mi>.</mi><mi>.</mi><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">i \in \{1, ..., N\}</annotation></semantics></math>
is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub><mo>=</mo><mfrac displaystyle="true"><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>‚àí</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mrow><munder><mo>‚àë</mo><mi>j</mi></munder><msub><mi>w</mi><mi>j</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">w_i = \dfrac{\left( x_i - \mathbb{E}[x_i | C_i] \right)^2 }{\sum_j w_j}</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
is the variable of interest and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
the vector of controls and fixed effects.</p>
</div>
<div class="section level2">
<h2 id="computing-observation-level-weights">Computing observation level weights<a class="anchor" aria-label="anchor" href="#computing-observation-level-weights"></a>
</h2>
<p>These weights are therefore the squared residuals of the regression
of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
on the full set of controls. They are computed using the same estimation
procedure as the one used in the main regression, just replacing the
outcome variable with the dependent variable of interest.</p>
</div>
<div class="section level2">
<h2 id="group-level-weights">Group level weights<a class="anchor" aria-label="anchor" href="#group-level-weights"></a>
</h2>
<p>One can compute group level weights by summing the weights of
observation within that group. This allows for a quick computation and
interpretation of weights at higher aggregation level.They correspond to
the within-group variance of the conditional treatment status.</p>
</div>
<div class="section level2">
<h2 id="what-do-they-represent-really">What do they represent really?<a class="anchor" aria-label="anchor" href="#what-do-they-represent-really"></a>
</h2>
<p>By definition, in the partialled out regression, these weights
represent the squared-distance to the center of the distribution of the
variable of interest, after partialling out the controls:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gapminder_sample</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>l_gdpPercap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">continent</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Africa"</span>, <span class="st">"Europe"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">country_codes</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg_ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html" class="external-link">feols</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">gapminder_sample</span>, </span>
<span>  <span class="va">lifeExp</span> <span class="op">~</span> <span class="va">l_gdpPercap</span> <span class="op">|</span> <span class="va">country</span>, </span>
<span>  cluster <span class="op">=</span> <span class="st">"country"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_partial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">reg_ex</span><span class="op">$</span><span class="va">call</span><span class="op">$</span><span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    lifeExp_per <span class="op">=</span> <span class="fu"><a href="../reference/idid_partial_out.html">idid_partial_out</a></span><span class="op">(</span><span class="va">reg_ex</span>, <span class="st">"lifeExp"</span>, <span class="st">"l_gdpPercap"</span><span class="op">)</span>,</span>
<span>    l_gdpPercap_per <span class="op">=</span> <span class="fu"><a href="../reference/idid_partial_out.html">idid_partial_out</a></span><span class="op">(</span><span class="va">reg_ex</span>, <span class="st">"l_gdpPercap"</span><span class="op">)</span>,</span>
<span>    weight <span class="op">=</span> <span class="fu"><a href="../reference/idid_weights.html">idid_weights</a></span><span class="op">(</span><span class="va">reg_ex</span>, <span class="st">"l_gdpPercap"</span><span class="op">)</span>,</span>
<span>    weight_log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">data_partial</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">l_gdpPercap_per</span>, y <span class="op">=</span> <span class="va">lifeExp_per</span>, color <span class="op">=</span> <span class="va">weight_log</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"lm"</span>,</span>
<span>    formula <span class="op">=</span> <span class="st">'y ~ x'</span>,</span>
<span>    color <span class="op">=</span> <span class="va">idid_colors_table</span><span class="op">[[</span><span class="st">"base"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    fill <span class="op">=</span> <span class="va">idid_colors_table</span><span class="op">[[</span><span class="st">"base"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html" class="external-link">geom_rug</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_idid.html">theme_idid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_fill_idid.html">scale_color_idid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Relationship between life expectancy and log GDP per capita"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"After partialling out country fixed effects"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Log GDP per capita (residualized)"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Life expectancy (residualized)"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Weight, compared to 1/n, the average weight"</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="background_files/figure-html/bivar_partial-1.png" width="2187.5"></p>
<p>While this pattern appears clearly in the partialled out regression,
it is much less visible when plotting the raw relationship:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_partial</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">gdpPercap</span>, y <span class="op">=</span> <span class="va">lifeExp</span>, color <span class="op">=</span> <span class="va">weight_log</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html" class="external-link">geom_rug</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_idid.html">theme_idid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_fill_idid.html">scale_color_idid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Relationship between life expectancy and GDP per capita"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Raw relationship"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"GDP per capita"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Life expectancy"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Weight, compared to 1/n, the average weight"</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="background_files/figure-html/bivar_raw-1.png" width="2187.5"></p>
<!-- # Are these weights actually weights? -->
<!-- # Equivalence between leverage and multiple regression weights -->
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://vincentbagilet.github.io/" class="external-link">Vincent Bagilet</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
