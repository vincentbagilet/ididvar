---
title: "Specification and variation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Specification and variation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This document discusses how `ididvar` can be used to discuss the impact of specification choices on the identifying variation weights and their distribution across observations. In particular, it discusses how the package can provide insights on how different levels of fixed effects affect the weights and the observations contributing to identification.

For this example, we use the `gapminder` data set built on [gapminder.org](https://www.gapminder.org/) and made available by the [`gapminder` package](https://jennybc.github.io/gapminder/index.html). It contains data on life expectency, GDP per capita and population, for all countries in the world, every 5 years between 1952 and 2007. As such, it constitutes a panel. 

```{r setup, message=FALSE}
library(ididvar)
library(gapminder)
library(fixest)
library(ggplot2)
library(dplyr)
library(purrr)
```

In this example, we are interested in studying the relationship between life expectancy and (log-)GDP per capita. We will consider several sets of fixed effects and study their impact on the variation used for identification.

## Exploration

Let's consider 3 regression models: with country fixed effects, year fixed effects and both. We do not include any additional controls for simplicity.

```{r reg}
gapminder_ext <- gapminder |> 
  dplyr::mutate(l_gdpPercap = log(gdpPercap)) |> 
  dplyr::filter(continent %in% c("Africa", "Europe")) |>
  dplyr::left_join(gapminder::country_codes, by = join_by(country))

reg_raw <- feols(data = gapminder_ext, lifeExp ~ l_gdpPercap)

reg_continent_fe <- feols(data = gapminder_ext, lifeExp ~ l_gdpPercap | continent)

reg_country_fe <- feols(data = gapminder_ext, lifeExp ~ l_gdpPercap | country)

reg_continent_year_fe <- feols(data = gapminder_ext, lifeExp ~ l_gdpPercap | continent^year)

reg_year_fe <- feols(data = gapminder_ext, lifeExp ~ l_gdpPercap | year)

reg_twfe <- feols(data = gapminder_ext, lifeExp ~ l_gdpPercap | country + year)

regs <- list(
  reg_raw = reg_raw, 
  reg_continent_fe = reg_continent_fe, 
  reg_country_fe = reg_country_fe, 
  reg_continent_year_fe = reg_continent_year_fe,
  reg_year_fe = reg_year_fe, 
  reg_twfe = reg_twfe
)
```

Of course, the parameter on `l_gdpPercap` does not represent the same quantity in each model. In `reg_country_fe`, it represents the within country relationship between `lifeExp` and `l_gdpPercap`, *ie* comparing observations at different points in time, within a given country. In `reg_year_fe`, it represents the within year and therefore across countries.

As always in applied econometrics, one the first steps in the analysis consists exploring the raw data and the relationship between the variables of interest.
We can then plot the partialled out versions of the relationships to get a sense of the variation partialled out by the various sets of fixed effects.

## Bivariate graphs {.tabset}

### Raw

```{r idid_viz_bivar, echo=FALSE}
lims <- ggplot2::lims(x = c(-3, 4.2), y = c(-42, 35)) 

bivar_raw <- idid_viz_bivar(reg_raw, "l_gdpPercap") + lims
bivar_continent_fe <- idid_viz_bivar(reg_continent_fe, "l_gdpPercap") + lims
bivar_country_year_fe <- idid_viz_bivar(reg_continent_year_fe, "l_gdpPercap") + lims
bivar_country_fe <- idid_viz_bivar(reg_country_fe, "l_gdpPercap") + lims
bivar_year_fe <- idid_viz_bivar(reg_year_fe, "l_gdpPercap") + lims
bivar_twfe <- idid_viz_bivar(reg_twfe, "l_gdpPercap") + lims
```

```{r bivar_raw, fig.asp=0.8, echo=FALSE}
bivar_raw
```

### Continent FEs

```{r bivar_continent_fe, fig.asp=0.8, echo=FALSE}
bivar_continent_fe
```

### Country FEs

```{r bivar_country_fe, fig.asp=0.8, echo=FALSE}
bivar_country_fe
```

### Year FEs

```{r bivar_year_fe, fig.asp=0.8, echo=FALSE}
bivar_year_fe
```

### TWFE

```{r bivar_twfe, fig.asp=0.8, echo=FALSE}
bivar_twfe
```

### Code

```{r bivar_code, eval=FALSE}
purrr::map(
  regs, 
  \(x) idid_viz_bivar(x, var_interest = "l_gdpPercap") + 
    ggplot2::lims(x = c(-3, 4.2), y = c(-42, 35))
)

# purrr::map(
#   regs, 
#   \(x) idid_viz_cumul(idid_weights(x, var_interest = "l_gdpPercap")) 
# )
```

## {-}

These graphs hopefully help understanding what the fixed effects are doing and what variation they are removing

In this particular case, regardless the set of fixed effects, the relationship is positive, despite the quantity estimated being somehow radically different.

## Weight graphs {.tabset}

### Raw

```{r weights, echo=FALSE}
graph_weights <- function(reg) {
  reg |> 
    idid_viz_weights("l_gdpPercap", var_x = year, var_y = country) +
    facet_grid(continent ~ ., scales = "free_y", space = "free_y") +
    theme(strip.text.y = element_text(angle = 0)) +
    labs(
      subtitle = paste("In the", deparse(substitute(reg)), "model"),
      caption = paste("Model:", deparse(reg$call[[2]])),
      x = NULL, 
      y = NULL
    )
}
```

```{r weights_raw, fig.asp=3, echo=FALSE}
graph_weights(reg_raw)
```

### Continent FEs

```{r weights_continent_fe, fig.asp=3, echo=FALSE}
graph_weights(reg_continent_fe)
```

### Country FEs

```{r weights_country_fe, fig.asp=3, echo=FALSE}
graph_weights(reg_country_fe)
```

### Year FEs

```{r weights_year_fe, fig.asp=3, echo=FALSE}
graph_weights(reg_year_fe)
```

### TWFE

```{r weights_twfe, fig.asp=3, echo=FALSE}
graph_weights(reg_twfe)
```

### Code

```{r code_weights, echo=TRUE, eval=FALSE}
graph_weights <- function(reg) {
  reg |> 
    idid_viz_weights("l_gdpPercap", var_x = year, var_y = country) +
    facet_grid(continent ~ ., scales = "free_y", space = "free_y") +
    theme(strip.text.y = element_text(angle = 0)) +
    labs(
      subtitle = paste("In the", deparse(substitute(reg)), "model"),
      caption = paste("Model:", deparse(reg$call[[2]])),
      x = NULL, 
      y = NULL
    )
}

map(regs, graph_weights)
```

## {-}

## Contribution graphs {.tabset}

### Raw

```{r contrib, echo=FALSE}
graph_contrib <- function(reg) {
  reg |> 
    idid_viz_contrib("l_gdpPercap", var_x = year, var_y = country) +
    facet_grid(continent ~ ., scales = "free_y", space = "free_y") +
    theme(strip.text.y = element_text(angle = 0)) +
    labs(
      caption = paste("Model:", deparse(reg$call[[2]])),
      x = NULL, 
      y = NULL
    )
}
```

```{r contrib_raw, fig.asp=3, echo=FALSE}
graph_contrib(reg_raw)
```

### Continent FEs

```{r contrib_continent_fe, fig.asp=3, echo=FALSE}
graph_weights(reg_continent_fe)
```

### Country FEs

```{r contrib_country_fe, fig.asp=3, echo=FALSE}
graph_weights(reg_country_fe)
```

### Year FEs

```{r contrib_year_fe, fig.asp=3, echo=FALSE}
graph_contrib(reg_year_fe)
```

### TWFE

```{r contrib_twfe, fig.asp=3, echo=FALSE}
graph_contrib(reg_twfe)
```

### Code

```{r code_contrib, echo=TRUE, eval=FALSE}
graph_contrib <- function(reg) {
  reg |> 
    idid_viz_contrib("l_gdpPercap", var_x = year, var_y = country) +
    facet_grid(continent ~ ., scales = "free_y", space = "free_y") +
    theme(strip.text.y = element_text(angle = 0)) +
    labs(
      caption = paste("Model:", deparse(reg$call[[2]])),
      x = NULL, 
      y = NULL
    )
}

map(regs, graph_contrib)
```



## Maps

```{r map, message=FALSE}
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)

world_sf <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") |> 
  dplyr::mutate(iso_alpha = adm0_a3) |> 
  dplyr::filter(iso_a3 != "ATA")

idid_viz_weights_map(reg_year_fe, "l_gdpPercap", world_sf, "iso_alpha") +
  coord_sf(crs = st_crs("ESRI:54030"))

idid_viz_contrib_map(reg_year_fe, "l_gdpPercap", world_sf, "iso_alpha") +
  coord_sf(crs = st_crs("ESRI:54030"))
```

## Effective sample

```{r effective_sample}
#| message: false

purrr::map(
  regs, 
  \(x) idid_contrib_stats(x, var_interest = "l_gdpPercap") |> 
    as_tibble() 
) |> 
  purrr::list_rbind() |> 
  mutate(reg = names(regs), .before = 1) |> 
  knitr::kable()
```












